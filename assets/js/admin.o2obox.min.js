((c,s,r)=>{function i(e){e.find(".o2o-icon").css("background-image","url("+s[r]._spinner+")")}function o(e){var t=e.closest("table");if(e.closest("tr").remove(),!t.find("tbody tr").length)t.hide()}function t(e){return c("#o2o-template-"+e).html()}let n={rtl:"rtl"===c("html").attr("dir"),strings:c.extend({},{confirm:"Are you sure you want to delete all connections?"},s[r].strings||{})},a=Backbone.Model.extend({}),l=Backbone.Model.extend({}),d=Backbone.Model.extend({sync:function(){let n=this;return this.ajaxRequest({subaction:"search"},function(e){var t=e.navigation;n.total_pages=(t?t["total-pages-raw"]:void 0)||1,n.trigger("sync",e)})},validate:function(e){e=e.paged;return 0<e&&e<=this.total_pages?null:"invalid page"}}),h=Backbone.Collection.extend({model:l,createItemAndConnect:function(e){let t=this;return this.ajaxRequest({subaction:"create_post",post_title:e},function(e){t.trigger("create",e)})},create:function(e){let t=this;e={subaction:"connect",to:e.get("id")};return this.ajaxRequest(e,function(e){t.trigger("create",e)})},delete:function(t){let n=this;var e={subaction:"disconnect",o2o_id:t.get("id")};return this.ajaxRequest(e,function(e){n.trigger("delete",e,t)})},clear:function(){let t=this;return this.ajaxRequest({subaction:"clear_connections"},function(e){t.trigger("clear",e)})}}),u=Backbone.View.extend({events:{"click th.o2o-col-delete .o2o-icon":"clear","click td.o2o-col-delete .o2o-icon":"delete"},initialize:function(e){this.options=e,this.maybe_make_sortable(),this.collection.on("create",this.afterCreate,this),this.collection.on("clear",this.afterClear,this)},maybe_make_sortable:function(){this.$("th.o2o-col-order").length&&this.$("tbody").sortable({handle:"td.o2o-col-order",helper:function(e,t){return t.children().each(function(){var e=c(this);e.width(e.width())}),t}})},clear:function(e){e.preventDefault(),confirm(n.strings.confirm)&&(e=c(e.target).closest("td"),i(e),this.collection.clear())},afterClear:function(){this.$el.hide().find("tbody").html("")},delete:function(e){e.preventDefault();let t=c(e.target).closest("td");i(t),this.collection.delete(new l({id:t.find("input").val()})).done(function(){o(t)})},afterCreate:function(e){this.$el.show().find("tbody").append(e.row),this.collection.trigger("append",e)}}),f=Backbone.View.extend({template:t("tab-list"),events:{"keypress :text":"handleReturn","keyup :text":"handleSearch","click .o2o-prev, .o2o-next":"changePage","click td.o2o-col-create div":"promote"},initialize:function(e){this.options=e,this.spinner=e.spinner,e.connections.on("delete",this.afterCandidatesRefreshed,this),e.connections.on("clear",this.afterCandidatesRefreshed,this),this.collection.on("sync",this.afterCandidatesRefreshed,this),this.collection.on("error",this.afterInvalid,this),this.collection.on("invalid",this.afterInvalid,this)},promote:function(e){let t=this,n=(e.preventDefault(),c(e.target).closest("td"));i(n);e=new a({id:n.find("div").data("item-id")});this.options.connections.create(e).done(function(){t.options.duplicate_connections?n.find(".o2o-icon").css("background-image",""):o(n)})},handleReturn:function(e){13===e.keyCode&&e.preventDefault()},handleSearch:function(e){let t=this;let n=c(e.target);setTimeout(function(){var e=n.val();e!==t.collection.get("s")&&(t.spinner.insertAfter(n).show(),t.collection.save({s:e,paged:1}))},400)},changePage:function(e){e=c(e.currentTarget);let t=this.collection.get("paged");e.hasClass("o2o-prev")?t--:t++,this.spinner.appendTo(this.$(".o2o-navigation")),this.collection.save("paged",t)},afterCandidatesRefreshed:function(e){this.spinner.remove(),this.$("button, .o2o-results, .o2o-navigation, .o2o-notice").remove(),"string"!=typeof e&&(e=Mustache.render(this.template,e,{"table-row":t("table-row")})),this.$el.append(e)},afterInvalid:function(){this.spinner.remove()}}),p=Backbone.View.extend({events:{"click button":"createItem","keypress :text":"handleReturn"},initialize:function(e){this.options=e,this.createButton=this.$("button"),this.createInput=this.$(":text")},handleReturn:function(e){13===e.keyCode&&(this.createButton.click(),e.preventDefault())},createItem:function(e){let t=this;if(e.preventDefault(),this.createButton.hasClass("inactive"))return!1;e=this.createInput.val();""===e?this.createInput.focus():(this.createButton.addClass("inactive"),this.collection.createItemAndConnect(e).done(function(){t.createInput.val(""),t.createButton.removeClass("inactive")}))}}),g=Backbone.View.extend({events:{"click .o2o-toggle-tabs":"toggleTabs","click .wp-tab-bar li":"setActiveTab"},initialize:function(e){this.options=e,this.spinner=e.spinner,this.initializedCandidates=!1,e.connections.on("append",this.afterConnectionAppended,this),e.connections.on("clear",this.afterConnectionDeleted,this),e.connections.on("delete",this.afterConnectionDeleted,this)},toggleTabs:function(e){e.preventDefault();e=this.$(".o2o-create-connections-tabs");e.toggle(),!this.initializedCandidates&&e.is(":visible")&&(this.options.candidates.sync(),this.initializedCandidates=!0)},setActiveTab:function(e){e.preventDefault();e=c(e.currentTarget);this.$(".wp-tab-bar li").removeClass("wp-tab-active"),e.addClass("wp-tab-active"),this.$el.find(".tabs-panel").hide().end().find(e.data("ref")).show().find(":text").focus()},afterConnectionAppended:function(e){"one"===this.options.cardinality&&this.$(".o2o-create-connections").hide()},afterConnectionDeleted:function(e){"one"===this.options.cardinality&&this.$(".o2o-create-connections").show()}});window.O2OAdmin={Candidate:a,Connection:l,boxes:{}},c(function(){c(".o2o-box").each(function(){var e=c(this),t=c("<img>",{src:s[r]._spinner,class:"o2o-spinner"});let i=new d({s:"",paged:1}),o=(i.total_pages=e.find(".o2o-total").data("num")||1,{o2o_type:e.data("o2o_type"),direction:e.data("direction"),from:c("#post_ID").val()});function n(e,n){e=c.extend({},e,i.attributes,o,{action:"o2o_box",nonce:s[r]._nonce});return c.post(ajaxurl,e,function(t){try{t=JSON.parse(t)}catch(e){return void("undefined"!=typeof console&&null!==console&&console.error("Malformed response",t))}return t.error?alert(t.error):n(t)})}i.ajaxRequest=n;var a=new h;a.ajaxRequest=n,new u({el:e.find(".o2o-connections"),collection:a,candidates:i}),new f({el:e.find(".o2o-tab-search"),collection:i,connections:a,spinner:t,duplicate_connections:e.data("duplicate_connections")}),new p({el:e.find(".o2o-tab-create-post"),collection:a}),new g({el:e,spinner:t,cardinality:e.data("cardinality"),candidates:i,connections:a});window.O2OAdmin.boxes[o.o2o_type]={candidates:i,connections:a}}),c(document).trigger("gEditorial:Module:Loaded",[r,n])})})(jQuery,gEditorial,"o2obox");