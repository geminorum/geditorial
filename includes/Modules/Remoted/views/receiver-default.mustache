<?php

class {{{identifier}}} {

	const DIR   = '{{{target}}}';
	const TOKEN = '{{{token}}}';

	public static function setup()
	{
		self::auth();
		self::init();
		self::handle();
	}

	public static function auth()
	{
		if ( empty( $_REQUEST['token'] ) )
			self::jsonrpc( -32600, 'Authentication Failed.' );

		if ( static::TOKEN !== trim( $_REQUEST['token'] ) )
			self::jsonrpc( -32600, 'Authentication Failed.' );
	}

	public static function handle()
	{
		if ( empty( $_FILES ) || $_FILES['file']['error'] )
			self::jsonrpc( 103, 'Failed to move uploaded file.' );

		$filePath = __DIR__.DIRECTORY_SEPARATOR.'..'.DIRECTORY_SEPARATOR.static::DIR;

		if ( ! file_exists( $filePath ) ) {
			if ( ! mkdir( $filePath, 0777, TRUE ) ) {
				self::jsonrpc( 100, 'Failed to open target directory.' );
			}
		}

		$fileName = isset( $_REQUEST['name'] ) ? $_REQUEST['name'] : $_FILES['file']['name'];
		$filePath = $filePath.DIRECTORY_SEPARATOR.$fileName;

		$chunk  = isset( $_REQUEST['chunk'] )  ? intval( $_REQUEST['chunk'] )  : 0;
		$chunks = isset( $_REQUEST['chunks'] ) ? intval( $_REQUEST['chunks'] ) : 0;
		$out    = @fopen( $filePath.'.part', $chunk == 0 ? 'wb' : 'ab' );

		if ($out) {

			$in = @fopen( $_FILES['file']['tmp_name'], 'rb' );

			if ( $in ) {

				while ( $buff = fread( $in, 4096 ) )
					fwrite( $out, $buff );

			} else {

				self::jsonrpc( 102, 'Failed to open output stream.' );
			}

			@fclose( $in );
			@fclose( $out );
			@unlink( $_FILES['file']['tmp_name'] );

		} else {

			self::jsonrpc( 102, 'Failed to open output stream.' );
		}

		if ( ! $chunks || $chunk == $chunks - 1 )
			rename( $filePath.'.part', $filePath );

		self::jsonrpc( FALSE );
	}

	public static function init()
	{
		error_reporting( E_ALL );
		ini_set( 'ignore_repeated_errors', 1 );
		ini_set( 'display_errors', FALSE );
		ini_set( 'log_errors', 1 );
		ini_set( 'error_log', __DIR__.DIRECTORY_SEPARATOR.'debug.log' );

		header( 'Expires: Mon, 26 Jul 1997 05:00:00 GMT' );
		header( 'Last-Modified: '.gmdate( 'D, d M Y H:i:s' ).' GMT' );
		header( 'Cache-Control: no-store, no-cache, must-revalidate' );
		header( 'Cache-Control: post-check=0, pre-check=0', FALSE );
		header( 'Pragma: no-cache' );

		header( 'Access-Control-Allow-Origin: *' );
		if ( $_SERVER['REQUEST_METHOD'] == 'OPTIONS' )
			exit; // finish preflight CORS requests here

		// 5 minutes execution time
		@set_time_limit( 5 * 60 );

		if ( isset( $_GET['ready'] ) )
			self::jsonrpc( FALSE );
	}

	public static function jsonrpc( $error = FALSE, $message = NULL )
	{
		$response = [
			'jsonrpc' => '2.0',
			'id'      => NULL,
		];

		if ( $error ) {

			http_response_code( 400 );
			$response['error'] = [
				'code'    => $error ?: '100',
				'message' => $message ?: NULL,
			];

		} else {

			http_response_code( 200 );
			$response['result'] = $message ?: NULL;
		}

		header( 'Content-Type: application/json; charset=utf-8' );
		die( json_encode( $response ) );
	}
}

{{{identifier}}}::setup();
